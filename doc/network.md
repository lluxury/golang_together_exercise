[TOC]

### 6 容器网络

####   网络虚拟化技术介绍

​    系统通过网络设备操纵网卡

#####     Linux虚拟网络设备

​      Veth

​      Bridge

​      802.1.q VLAN device
​      TAP

######     Veth

​      成对出现，跨 namespace
​      也需要路由

######     Bridge

​      桥接网络
​      相当于交换机
​      通过mac 广播或转发

#####     Linux路由表

​      内核模块
​      决定 网络 namespace 中包流向
​    Linux iptables
​      对内核 netfilter 模块操作和展示

######       MASQUERADE

​        修改请求包源地址

######       DNAT

​        更换请求包目标地址
​      SNAT
​        区别？

#####     Go语言网络库介绍

​      net
​        跨平台网络地址处理
​        各种协议 TCP, UDP, DNS, Unix Socket
​      net.IP
​        IP 地址数据结构
​      net.IPNet
​        IP段数据结构
​      vishvananda/netlink
​        网络接口，路由表
​      vishvananda/netns
​        在容器 Net Namespace 中执行



####   构建容器网络模型

#####     模型

######       网络

​        容器的集合
​        一个网络上的容器可以互连
​        需要地址段和驱动

######       网络端点

​        连接容器与网络
​        例如 Veth
​        地址，Veth，端口映射，连接容器，网络

######       网络驱动

​        组件，创建网络时指定

######       IPAM

​        组件，IP地址的分配和释放

#####     调用关系

######       创建网络

​        原理
​          IPAM 通过传入 IP 段分配 IP 保证不冲突
​          Network Driver 完成初始化和端点配置
​          例如创建 Linux Bridge 挂载 Veth
​        流程
​          创建网络
​          获取 IP段和 GatewayIR
​          返回网段配置
​          创建网络
​          配置网络设备
​          返回配置好的网络信息
​          确认创建完成
​        代码

######       创建容器连接网络

​        流程
​          创建容器
​          获取容器 IP
​          返回 IP
​          创建网络端点
​          配置连接网络端点
​          确认配置完成
​          配置端口映射
​          确认创建完成
​        代码

######       展示网络列表

​        代码

######       删除网络

​        流程
​          删除网络
​          删了网络关联IP
​          确认删除完成
​          删除网络内对应设备
​          确认删除完成
​          删除网络配置文件
​          确认删除完成
​        代码

####   容器地址分配

​    需要实现 IP 在网络中唯一

​    bitmap算法介绍

​      位图算法
​      大规模少状态的处理
​      1位来表示状态

######     数据结构定义

######     地址分配的实现

######     地址释放的实现

​    测试

####   创建Bridge网络

######     Bridge Driver Create实现

######     Bridge Driver初始化Linux Bridge流程

​      创建Brdige虚拟设备
​      设置Bridge 设备和路由
​      启动 Bridge 设备
​      设置 iptables SNAT 规则
​    代码
​      创建Brdige虚拟设备
​      设置Bridge 设备和路由
​      启动 Bridge 设备
​      设置 iptables SNAT 规则

######     Bridge Driver Delete实现

​    测试

####   在Bridge网络创建容器

​    挂载容器端点的流程
​    代码

######       创建 Veth

######       挂载一端到Bridge

######       另一端移到 netns

######       设置另一端 IP

######       设置 netns 路由

######       设置端口映射

​    测试
​      容器互联
​      容器访问外部网络
​      容器映射端口到宿主机

####   容器跨主机网络

#####     原因

​      Linux Bridge 没办法路由到宿主机外部
​      只能通过端口映射来访问

#####     跨主机容器网络的IPAM

​      IPAM 没办法多个宿主机用一份文件
​      一致性 KV-store
​        全局锁，原子方法
​        etcd，consul，zk

#####     跨主机容器网络通信的常见实现方式

######       封包

​        容器间请求包上宿主机地址发送
​        到达后解包获得请求
​        封包
​          Vxlan
​          Ipip-tunnel
​          GRE
​          自定格式



######       路由

​        让宿主机网络知道容器地址怎么路由
​        修改路由表，需要网络设备支持
​        修改容器 IP 地址的下一跳
​        路由器的路由表，Vlan，VPC路由表
​      

对比
        封包 基础设施要求低，性能耗损大
        路由，性能好，对网络支持有要求