[TOC]

### 5 构建容器进阶

####   实现容器的后台运行

​    原因
​      需求后台运行
​      否则 docker 服务挂掉，全体会容器宕掉
​      要求父进程创建完子进程后，detach掉子进程
​      runc 实现
​      mydocker 进程退出， init 接管
​    代码
​      处理 -d 标签
​      createTty 和 detach 不能共存？

####   实现查看运行中容器

#####     准备数据

​      代码
​        保存数据的位置
​        name标签
​        记录容器相关信息
​      流程
​        解析容器名
​        创建容器
​        存储容器信息到磁盘
​        确认创建完成
​        确认创建完成

#####     实现mydocker ps

​      代码
​      流程
​        解析 mydocker ps
​        传递容器名
​        根据名字查询信息
​        返回数据
​        使用 tabwrite 格式化数据
​        输出信息

####   实现查看容器日志

​    代码
​      保存容器标准输出
​      /var/run/mydocker/xx/container.log

####   实现进入容器Namespace

​    原因
​      创建后无法再进入容器
​      setns
​        是一个系统调用
​        根据 pid 进入 指定 namespace
​        多线程进程无法使用 setns
​        借助c语言调用

#####     Cgo

​      容许 go 程序 调用 c程序的标准库
​      注意写法

#####     实现命令

​      原理
​        使用构造函数，一但引用就启动
​        用环境变量做开关，控制使用范围
​      代码
​      流程
​        docker exec 容器名 命令
​        解析容器名和命令
​        获取容器pid ，设置环境变量
​        设置环境变量，fork 出新进程
​        启动新进程
​        进程调用自己
​        c 调用 setns 进入 naeespace 执行命令
​        运行完毕退出

####   实现停止容器

​    原理
​      找到主进程 PID
​      发送 SIGTERM 信号
​      等进程结束
​    代码
​      检查容器名
​    流程
​      docker stop 容器名
​      解析容器名
​      获取容器pid ，kill
​      确认 kill 成功 修改容器信息状态
​      确认 kill 完毕
​      确认停止容器完成

####   实现删除容器

​    代码
​    流程
​      根据名字查找信息
​      判断容器状态
​      查找容器存储信息地址
​      移除记录容器信息的文件

####   实现通过容器制作镜像

​    原因
​      多个容器后台运行时
​      使用一个镜像启动多个容器
​      会使用同一个 AUFS 文件系统
​      可写层会相互影响
​    代码
​      为每个容器分配单独的隔离文件系统
​      修改 mydocker commit 命令，为不同容器打包

####   实现容器指定环境变量运行

​    原因
​      希望容器内程序使用外部环境变量
​      需要获取 os 变量，再加入自定义变量
​    代码
​      修改runCommand
​      修改Run函数
​      修改NewParentProcess函数
​      修改mydocker exec命令
​        解决 env 不能获取变量总是

